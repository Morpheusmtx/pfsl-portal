<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Pago F√°cil San Lucas / Despensa LyR</title>
<meta name="color-scheme" content="light dark">
<style>
  :root{
    --bg:#0b0f19;--card:#111827;--muted:#9aa4b2;--text:#e6e9ef;
    --ig1:#e1306c;--ig2:#f56040;--fb:#1877f2;--ok:#22c55e;--disabled:#334155;
    --ring:#1f2937
  }
  *{box-sizing:border-box}
  body{margin:0;min-height:100vh;display:grid;place-items:center;
       background:radial-gradient(80% 80% at 50% -10%,#1f2842 0%,#0b0f19 60%);
       color:var(--text);font:16px/1.5 system-ui,Segoe UI,Roboto,Arial}
  .wrap{width:min(560px,92%);background:linear-gradient(180deg,#141a2a,#0e1424);
        border:1px solid var(--ring);border-radius:16px;padding:22px;box-shadow:0 20px 50px #0008}
  h1{margin:4px 0 2px;font-size:22px}
  p.sub{margin:0 0 16px;color:var(--muted)}
  .step{border:1px solid #222b3f;border-radius:14px;padding:16px;margin:14px 0;background:#0c1222}
  .head{display:flex;align-items:center;gap:10px;margin-bottom:12px}
  .badge{width:28px;height:28px;border-radius:8px;background:#1f2937;display:grid;place-items:center;font-weight:700;color:#cbd5e1}
  .title{font-weight:800}
  .btn{width:100%;border:0;border-radius:12px;padding:14px 16px;font-weight:800;cursor:pointer;color:#fff}
  .btn-ig{background:linear-gradient(90deg,var(--ig2),var(--ig1))}
  .btn-fb{background:var(--fb)}
  .btn-go{background:var(--disabled)}
  .btn-go.enabled{background:var(--ok);color:#0b1222}
  .hint{margin-top:10px;color:#94a3b8;font-size:14px}
  .mark{margin-top:10px;color:#86efac;font-weight:700;display:none}
  .mark.show{display:block}
  .spinner{width:16px;height:16px;border:3px solid #ffffff40;border-top-color:#fff;border-radius:50%;display:inline-block;vertical-align:-3px;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(1turn)}}
  .foot{margin-top:6px;text-align:center;color:#64748b;font-size:12px}
</style>
</head>
<body>
  <main class="wrap" role="status" aria-live="polite">
    <h1>Pago F√°cil San Lucas / Despensa LyR</h1>
    <p class="sub">üí° Complet√° estos <b>3 pasos</b> (r√°pido y simple). Al final te llevamos a nuestras promos.</p>

    <!-- Paso 1 -->
    <section class="step" id="s1">
      <div class="head">
        <div class="badge">1</div>
        <div class="title">Segu√≠ nuestro <b>Instagram</b></div>
      </div>
      <button class="btn btn-ig" id="btnIg" type="button">Abrir Instagram</button>
      <div class="mark" id="ok1">‚úî Marcado</div>
      <div class="hint">Si ten√©s la app, el tel√©fono te la va a ofrecer abrir.</div>
    </section>

    <!-- Paso 2 -->
    <section class="step" id="s2">
      <div class="head">
        <div class="badge">2</div>
        <div class="title">Segu√≠ nuestro <b>Facebook</b></div>
      </div>
      <button class="btn btn-fb" id="btnFb" type="button">Abrir Facebook</button>
      <div class="mark" id="ok2">‚úî Marcado</div>
    </section>

    <!-- Paso 3 -->
    <section class="step" id="s3">
      <div class="head">
        <div class="badge">3</div>
        <div class="title">Finalizar</div>
      </div>
      <button class="btn btn-go" id="btnGo" type="button" disabled>Ir a promociones</button>
      <div class="hint" id="msg"><span class="spinner" style="display:none" id="sp"></span> Listo para finalizar cuando marques 1 y 2.</div>
    </section>

    <div class="foot">¬© Pago F√°cil San Lucas / Despensa LyR</div>
  </main>

<script>
(function(){
  "use strict";
  const LINKS = {
    ig: "https://www.instagram.com/pagofacil_sanlucas",
    fb: "https://www.facebook.com/PagoFacilSanLucas",
    odoo: "https://pagofacilsanlucas.odoo.com/"
  };
  const qs = new URLSearchParams(location.search);
  const authUrl = qs.get("authUrl") || ""; // Omada (External Portal) suele pasar authUrl aqu√≠
  const $ = s => document.querySelector(s);
  const state = { ig:false, fb:false, authed:false };

  // Guarda el progreso por si el usuario vuelve desde la app
  const saved = sessionStorage.getItem("pfsl_steps");
  if(saved){
    try{ Object.assign(state, JSON.parse(saved)); }catch(_){}
  }
  restoreUI();

  function persist(){ sessionStorage.setItem("pfsl_steps", JSON.stringify(state)); }

  function openInNew(url){
    try { window.open(url, "_blank"); }
    catch { location.href = url; }
  }

  // Autoriza contra Omada usando "pixel request" (evita CORS)
  function authorize(){
    return new Promise((resolve)=>{
      if(state.authed || !authUrl){ state.authed = true; persist(); return resolve(true); }
      const img = new Image();
      const t = setTimeout(()=>{ state.authed=true; persist(); resolve(true); }, 1200);
      img.onload = ()=>{ clearTimeout(t); state.authed=true; persist(); resolve(true); };
      img.onerror = ()=>{ clearTimeout(t); state.authed=true; persist(); resolve(true); };
      img.src = authUrl + (authUrl.includes("?") ? "&" : "?") + "_ts=" + Date.now();
    });
  }

  function maybeEnableFinish(){
    const go = $("#btnGo");
    if(state.ig && state.fb){
      go.disabled = false;
      go.classList.add("enabled");
      $("#msg").textContent = "¬°Genial! Toc√° para ver nuestras promos.";
    }
  }

  function restoreUI(){
    if(state.ig) $("#ok1").classList.add("show");
    if(state.fb) $("#ok2").classList.add("show");
    maybeEnableFinish();
  }

  $("#btnIg").addEventListener("click", async ()=>{
    openInNew(LINKS.ig);
    $("#ok1").classList.add("show");
    state.ig = true; persist();
    // Primer toque: aprovechamos para autorizar
    await authorize();
    maybeEnableFinish();
  });

  $("#btnFb").addEventListener("click", async ()=>{
    openInNew(LINKS.fb);
    $("#ok2").classList.add("show");
    state.fb = true; persist();
    await authorize();
    maybeEnableFinish();
  });

  $("#btnGo").addEventListener("click", ()=>{
    // Ya est√° autorizado desde los pasos 1/2. Redirigimos a tu landing.
    location.href = LINKS.odoo;
  });

  // Fallback: si el CNA mata el JS, dejamos un meta-refresh suave
  const meta = document.createElement("meta");
  meta.httpEquiv = "refresh";
  meta.content = "600"; // nada agresivo; s√≥lo por si queda colgado 10 minutos
  document.head.appendChild(meta);
})();
</script>
</body>
</html>
