<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Pago Fácil San Lucas / Despensa LyR – Conexión</title>
<meta name="color-scheme" content="light dark">
<style>
  :root{
    --bg:#0b0f19;--card:#111827;--text:#e6e9ef;--muted:#9aa4b2;--ring:#1f2937;
    --ig1:#f56040;--ig2:#e1306c;--fb:#1877f2;--ok:#22c55e;--warn:#f59e0b;--disabled:#334155
  }
  *{box-sizing:border-box}
  body{margin:0;min-height:100vh;display:grid;place-items:center;
       background:radial-gradient(80% 80% at 50% -10%,#1f2842 0%,#0b0f19 60%);
       color:var(--text);font:16px/1.5 system-ui,Segoe UI,Roboto,Arial}
  .wrap{width:min(560px,92%);background:linear-gradient(180deg,#141a2a,#0e1424);
        border:1px solid var(--ring);border-radius:16px;padding:22px;box-shadow:0 20px 50px #0008}
  h1{margin:4px 0 2px;font-size:22px}
  p.sub{margin:0 0 16px;color:var(--muted)}
  .step{border:1px solid #222b3f;border-radius:14px;padding:16px;margin:14px 0;background:#0c1222}
  .head{display:flex;align-items:center;gap:10px;margin-bottom:12px}
  .badge{width:28px;height:28px;border-radius:8px;background:#1f2937;display:grid;place-items:center;font-weight:700;color:#cbd5e1}
  .title{font-weight:800}
  .btn{display:block;text-align:center;width:100%;border:0;border-radius:12px;padding:14px 16px;
       font-weight:800;cursor:pointer;color:#fff;text-decoration:none}
  .btn-ig{background:linear-gradient(90deg,var(--ig2),var(--ig1))}
  .btn-fb{background:var(--fb)}
  .btn-go{background:var(--disabled)}
  .btn-go.one{background:linear-gradient(90deg,var(--warn),#eab308);color:#0b1222}
  .btn-go.ready{background:var(--ok);color:#0b1222}
  .mark{margin-top:10px;color:#86efac;font-weight:700;display:none}
  .mark.show{display:block}
  .hint{margin-top:10px;color:#94a3b8;font-size:14px}
  .foot{margin-top:8px;text-align:center;color:#64748b;font-size:12px}
  .state{margin-top:12px;font-size:12px;color:#94a3b8}
  .tools{margin-top:8px}
  .force{display:none;margin-top:8px;font-size:12px;color:#cbd5e1;text-decoration:underline;cursor:pointer}
</style>
</head>
<body>
  <main class="wrap" role="status" aria-live="polite">
    <h1>Pago Fácil San Lucas / Despensa LyR</h1>
    <p class="sub">Completá estos <b>3 pasos</b> (rápido) y listo ✅</p>

    <!-- Paso 1 -->
    <section class="step">
      <div class="head"><div class="badge">1</div><div class="title">Seguí nuestro <b>Instagram</b></div></div>
      <a class="btn btn-ig" id="ig" href="https://www.instagram.com/pagofacil_sanlucas">Abrir Instagram</a>
      <div class="mark" id="ok1">✔ Marcado</div>
      <div class="hint">Si tenés la app, el teléfono te la va a ofrecer abrir.</div>
    </section>

    <!-- Paso 2 -->
    <section class="step">
      <div class="head"><div class="badge">2</div><div class="title">Seguí nuestro <b>Facebook</b></div></div>
      <a class="btn btn-fb" id="fb" href="https://www.facebook.com/PagoFacilSanLucas">Abrir Facebook</a>
      <div class="mark" id="ok2">✔ Marcado</div>
    </section>

    <!-- Paso 3 -->
    <section class="step">
      <div class="head"><div class="badge">3</div><div class="title">Finalizar</div></div>
      <button class="btn btn-go" id="go" type="button">Conexión lista</button>
      <div class="state" id="state"></div>
      <div class="tools"><span id="force" class="force">¿No te deja navegar? Forzar conexión</span></div>
    </section>

    <div class="foot">© Pago Fácil San Lucas / Despensa LyR</div>
  </main>

  <img id="pixel" alt="" style="display:none;width:1px;height:1px">
<script>
(function(){
  "use strict";
  // URLs destino
  const IG = "https://www.instagram.com/pagofacil_sanlucas";
  const FB = "https://www.facebook.com/PagoFacilSanLucas";

  // Helpers DOM
  const $ = s => document.querySelector(s);
  const pixel = $("#pixel"), st = $("#state"), btnGo = $("#go"), linkIg=$("#ig"), linkFb=$("#fb"), force=$("#force");

  // Leer authUrl (External Portal) — si no viene, asumimos Cloud (ya online)
  const qs = new URLSearchParams(location.search);
  const authUrl = qs.get("authUrl") || qs.get("authurl") || "";

  // Estado (namespaced)
  let state = { ig:false, fb:false, authed:false, tried:false };
  try{
    const saved = JSON.parse(sessionStorage.getItem("pfsl_state")||"{}");
    state = Object.assign(state, saved);
  }catch(_){}

  if(!authUrl) { // Cloud Essentials: ya están online
    state.authed = true;
    paint("Conectado (modo Cloud).");
  } else {
    paint("Listo para conectar…");
    // No disparamos automáticamente; lo haremos al primer clic para no molestar al CNA
  }

  // Persistencia
  function persist(){ try{ sessionStorage.setItem("pfsl_state", JSON.stringify(state)); }catch(_){} }

  // UI: checks y botón 3
  function updateUI(){
    if(state.ig) $("#ok1").classList.add("show");
    if(state.fb) $("#ok2").classList.add("show");

    if(state.ig && state.fb){
      btnGo.classList.add("ready");
      btnGo.classList.remove("one");
      btnGo.textContent = "✅ Conexión establecida";
    } else if (state.ig || state.fb){
      btnGo.classList.remove("ready");
      btnGo.classList.add("one");
      btnGo.textContent = "¡Ya casi! Falta 1 paso…";
    } else {
      btnGo.classList.remove("ready","one");
      btnGo.textContent = "Conexión lista";
    }

    // “Forzar conexión” visible solo si hay authUrl y aún no estamos authed tras un rato
    if(authUrl && !state.authed){
      force.style.display = "inline-block";
    } else {
      force.style.display = "none";
    }
  }

  // Estado/diagnóstico discreto
  function paint(msg){ st.textContent = msg; }

  // Autorización vía pixel (evita CORS)
  function authorize(){
    return new Promise((resolve)=>{
      if(state.authed || !authUrl){ return resolve(true); }
      if(state.tried) { return resolve(true); }
      state.tried = true; persist();
      paint("Conectando…");

      const u = authUrl + (authUrl.includes("?")?"&":"?") + "_ts=" + Date.now();
      let done = false;
      const finish = (txt)=>{ if(done) return; done=true; state.authed=true; persist(); paint(txt||"Conectado ✔"); updateUI(); resolve(true); };
      const t = setTimeout(()=>finish("Conectado (timeout) ✔"), 1200);

      pixel.onload  = ()=>{ clearTimeout(t); finish("Conectado ✔"); };
      pixel.onerror = ()=>{ clearTimeout(t); finish("Conectado (fallback) ✔"); };
      pixel.src = u;
    });
  }

  // Abrir destinos en la MISMA vista (mejor en CNA)
  async function authorizeThenGo(url){
    if(!state.authed){ await authorize(); }
    setTimeout(()=>{ location.href = url; }, state.authed ? 200 : 500);
  }

  // Eventos IG/FB: marcar ✔ y navegar (tras auth si aplica)
  linkIg.addEventListener("click", (e)=>{ e.preventDefault(); state.ig=true; persist(); $("#ok1").classList.add("show"); updateUI(); authorizeThenGo(IG); }, {passive:false});
  linkFb.addEventListener("click", (e)=>{ e.preventDefault(); state.fb=true; persist(); $("#ok2").classList.add("show"); updateUI(); authorizeThenGo(FB); }, {passive:false});

  // Botón final: feedback + tratar de cerrar popup
  btnGo.addEventListener("click", ()=>{
    paint("Conexión establecida ✔. Ya podés navegar o cerrar esta ventana.");
    try{ window.close(); }catch(_){}
  }, {passive:true});

  // Forzar conexión manual si algo se colgó
  force.addEventListener("click", ()=>{ state.authed=false; state.tried=false; persist(); authorize(); }, {passive:true});

  // Init
  updateUI();
})();
</script>
</body>
</html>
