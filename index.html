<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Pago Fácil San Lucas – Conexión</title>
<style>
  :root{--bg:#121212;--card:#1e1e1e;--text:#fff;--muted:#b3b3b3;--yellow:#facc15;--green:#16a34a;--gray:#3f3f46;}
  *{box-sizing:border-box} body{margin:0;min-height:100vh;display:grid;place-items:center;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,Segoe UI,Roboto}
  .card{width:min(440px,92%);background:var(--card);padding:20px 18px;border-radius:14px;box-shadow:0 8px 28px rgba(0,0,0,.35)}
  h1{margin:0 0 2px;font-size:22px} p{margin:0 0 14px;color:var(--muted)}
  .status{display:flex;align-items:center;gap:8px;margin:10px 0 14px;font-size:13px;color:#cbd5e1}
  .dot{width:9px;height:9px;border-radius:50%;}
  .dot.red{background:#ef4444}.dot.yellow{background:var(--yellow)}.dot.green{background:var(--green)}
  .step{margin:14px 0;padding:12px;border:1px solid #2a2a2a;border-radius:10px}
  .badge{display:inline-block;font-size:12px;color:#0ea5e9;border:1px solid #0ea5e9;border-radius:999px;padding:2px 8px;margin-bottom:6px}
  .btn{display:inline-flex;justify-content:center;align-items:center;width:100%;padding:12px 14px;border:0;border-radius:10px;color:#fff;font-weight:700}
  .ig{background:linear-gradient(90deg,#f58529,#dd2a7b,#8134af,#515bd4)}
  .fb{background:#1877f2}
  #connectBtn{background:var(--gray)}
  #connectBtn.yellow{background:var(--yellow);color:#111}
  #connectBtn.green{background:var(--green);color:#fff}
  small{color:#9aa3af}
</style>
</head>
<body>
  <main class="card">
    <h1>Pago Fácil San Lucas / Despensa LyR</h1>
    <div class="status">
      <span id="authDot" class="dot red"></span>
      <span id="authMsg">Buscando autorización…</span>
    </div>
    <p>Hacé estos 3 pasos y ¡listo!</p>

    <section id="step1" class="step">
      <span class="badge">Paso 1</span>
      <h3>Seguí nuestro Instagram</h3>
      <button class="btn ig" id="igBtn">Abrir Instagram</button>
    </section>

    <section id="step2" class="step">
      <span class="badge">Paso 2</span>
      <h3>Seguí nuestro Facebook</h3>
      <button class="btn fb" id="fbBtn">Abrir Facebook</button>
    </section>

    <section class="step">
      <button id="connectBtn" class="btn">Conexión lista</button>
      <p style="margin-top:10px"><small>Si el navegador te muestra un aviso, elegí “Continuar en el navegador”.</small></p>
    </section>
  </main>

<script>
  const igBtn = document.getElementById('igBtn');
  const fbBtn = document.getElementById('fbBtn');
  const connectBtn = document.getElementById('connectBtn');
  const authDot = document.getElementById('authDot');
  const authMsg = document.getElementById('authMsg');

  const qs = new URLSearchParams(location.search);
  const authUrl = qs.get('authUrl') || qs.get('authurl') || '';

  function setStatus(color, msg){
    authDot.className = 'dot ' + color;
    authMsg.textContent = msg;
  }

  function pingAuth(){
    if(!authUrl){ setStatus('red','Sin token de autorización (authUrl no presente)'); return; }
    setStatus('yellow','Autorizando…');
    const img = new Image();
    img.onload = () => setStatus('green','Conexión habilitada ✔');
    img.onerror = () => setStatus('yellow','Reintentando autorización…');
    img.src = authUrl + (authUrl.includes('?') ? '&' : '?') + '_ts=' + Date.now();
  }

  // Estado de pasos
  function updateCTA(){
    const ig = sessionStorage.getItem('igDone') === 'true';
    const fb = sessionStorage.getItem('fbDone') === 'true';
    if(ig && fb){ connectBtn.className='btn green'; connectBtn.textContent='✅ Conexión establecida'; }
    else if(ig || fb){ connectBtn.className='btn yellow'; connectBtn.textContent='¡Ya casi! Falta 1 paso…'; }
    else{ connectBtn.className='btn'; connectBtn.textContent='Conexión lista'; }
  }

  igBtn.onclick = () => {
    sessionStorage.setItem('igDone','true');
    updateCTA();
    window.open('https://www.instagram.com/pagofacil_sanlucas','_blank','noopener');
  };
  fbBtn.onclick = () => {
    sessionStorage.setItem('fbDone','true');
    updateCTA();
    // FB móvil suele forzar m-dot
    window.open('https://m.facebook.com/PagoFacilSanLucas','_blank','noopener');
  };
  connectBtn.onclick = pingAuth;

  // Init
  if(sessionStorage.getItem('igDone')==='true'){}
  if(sessionStorage.getItem('fbDone')==='true'){}
  updateCTA();
  // Auto-autoriza apenas llegamos
  pingAuth();
  // Un segundo intento por si el primero cae en el limbo del CNA
  setTimeout(pingAuth, 1200);
</script>
</body>
</html>
