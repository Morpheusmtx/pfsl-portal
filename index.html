<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Pago Fácil San Lucas / Despensa LyR – Conexión</title>
<meta name="color-scheme" content="light dark">
<style>
  :root{
    --bg:#0b0f19;--card:#111827;--muted:#9aa4b2;--text:#e6e9ef;
    --ig1:#e1306c;--ig2:#f56040;--fb:#1877f2;
    --ok:#22c55e;--disabled:#334155;--ring:#1f2937;--accent:#60a5fa
  }
  *{box-sizing:border-box}
  body{
    margin:0;min-height:100vh;display:grid;place-items:center;
    background:radial-gradient(80% 80% at 50% -10%,#1f2842 0%,#0b0f19 60%);
    color:var(--text);font:16px/1.5 system-ui,Segoe UI,Roboto,Arial
  }
  .wrap{
    width:min(560px,92%);background:linear-gradient(180deg,#141a2a,#0e1424);
    border:1px solid var(--ring);border-radius:16px;padding:22px;box-shadow:0 20px 50px #0008
  }
  h1{margin:4px 0 2px;font-size:22px}
  p.sub{margin:0 0 16px;color:var(--muted)}
  .step{border:1px solid #222b3f;border-radius:14px;padding:16px;margin:14px 0;background:#0c1222}
  .head{display:flex;align-items:center;gap:10px;margin-bottom:12px}
  .badge{width:28px;height:28px;border-radius:8px;background:#1f2937;display:grid;place-items:center;font-weight:700;color:#cbd5e1}
  .title{font-weight:800}
  .btn{width:100%;border:0;border-radius:12px;padding:14px 16px;font-weight:800;cursor:pointer;color:#fff;transition:transform .05s ease}
  .btn:active{transform:scale(.995)}
  .btn-ig{background:linear-gradient(90deg,var(--ig2),var(--ig1))}
  .btn-fb{background:var(--fb)}
  .btn-go{background:var(--disabled)}
  .btn-go.enabled{background:var(--ok);color:#0b1222}
  .btn-go.progress{background:linear-gradient(90deg,#f59e0b,#22c55e);color:#0b1222}
  .hint{margin-top:10px;color:#94a3b8;font-size:14px}
  .mark{margin-top:10px;color:#86efac;font-weight:700;display:none}
  .mark.show{display:block}
  .okline{margin-top:10px;color:#86efac;font-weight:700;display:none;text-align:center}
  .foot{margin-top:6px;text-align:center;color:#64748b;font-size:12px}
</style>
</head>
<body>
  <main class="wrap" role="status" aria-live="polite">
    <h1>Pago Fácil San Lucas / Despensa LyR</h1>
    <p class="sub">Completá estos <b>3 pasos</b> (rápido) y listo ✅</p>

    <!-- Paso 1: Instagram -->
    <section class="step" id="s1">
      <div class="head">
        <div class="badge">1</div>
        <div class="title">Seguí nuestro <b>Instagram</b></div>
      </div>
      <button class="btn btn-ig" id="btnIg" type="button">Abrir Instagram</button>
      <div class="mark" id="ok1">✔ Marcado</div>
      <div class="hint">Si tenés la app, el teléfono te la va a ofrecer abrir.</div>
    </section>

    <!-- Paso 2: Facebook -->
    <section class="step" id="s2">
      <div class="head">
        <div class="badge">2</div>
        <div class="title">Seguí nuestro <b>Facebook</b></div>
      </div>
      <button class="btn btn-fb" id="btnFb" type="button">Abrir Facebook</button>
      <div class="mark" id="ok2">✔ Marcado</div>
    </section>

    <!-- Paso 3: Finalizar (psicológico) -->
    <section class="step" id="s3">
      <div class="head">
        <div class="badge">3</div>
        <div class="title">Finalizar</div>
      </div>
      <button class="btn btn-go" id="btnGo" type="button" disabled>Faltan 2 pasos…</button>
      <div class="hint" id="msg">Primero Instagram y Facebook. Luego finalizás.</div>
      <div class="okline" id="okline">✔ Conexión establecida. Ya podés seguir navegando.</div>
    </section>

    <div class="foot">© Pago Fácil San Lucas / Despensa LyR</div>
  </main>

<script>
(function(){
  "use strict";
  const LINKS = {
    ig: "https://www.instagram.com/pagofacil_sanlucas",
    fb: "https://www.facebook.com/PagoFacilSanLucas"
  };

  // Omada (External Portal) suele pasar authUrl en la query
  const qs = new URLSearchParams(location.search);
  const authUrl = qs.get("authUrl") || "";

  const $ = s => document.querySelector(s);
  const btnIg = $("#btnIg");
  const btnFb = $("#btnFb");
  const btnGo = $("#btnGo");
  const msg   = $("#msg");

  const state = { ig:false, fb:false, authed:false };

  // Si el usuario vuelve desde las apps, mantenemos progreso
  try{
    Object.assign(state, JSON.parse(sessionStorage.getItem("pfsl_steps")||"{}"));
  }catch(_){}
  updateUI();

  function persist(){ sessionStorage.setItem("pfsl_steps", JSON.stringify(state)); }
  function openNew(u){ try{ window.open(u,"_blank"); }catch{ location.href=u; } }

  // Autoriza contra Omada usando una "pixel request" (evita CORS)
  function authorize(){
    return new Promise((resolve)=>{
      if(state.authed || !authUrl){ state.authed = true; persist(); return resolve(true); }
      const img = new Image();
      // timeout corto: si no carga igual damos por ok (Omada suele responder 204/302)
      const t = setTimeout(()=>{ state.authed = true; persist(); resolve(true); }, 1200);
      img.onload  = ()=>{ clearTimeout(t); state.authed = true; persist(); resolve(true); };
      img.onerror = ()=>{ clearTimeout(t); state.authed = true; persist(); resolve(true); };
      img.src = authUrl + (authUrl.includes("?")?"&":"?") + "_ts=" + Date.now();
    });
  }

  function updateUI(){
    // Marcas ✔
    if(state.ig) $("#ok1").classList.add("show");
    if(state.fb) $("#ok2").classList.add("show");

    // Texto del botón 3 según progreso
    if(state.ig && state.fb){
      btnGo.disabled = false;
      btnGo.classList.add("enabled");
      btnGo.classList.remove("progress");
      btnGo.textContent = "Conexión lista";
      msg.textContent = "Tocá para finalizar.";
    }else if(state.ig || state.fb){
      btnGo.disabled = true;
      btnGo.classList.add("progress");
      btnGo.textContent = "¡Ya casi! Falta 1 paso…";
      msg.textContent = "Marcá el paso que falta para finalizar.";
    }else{
      btnGo.disabled = true;
      btnGo.classList.remove("progress");
      btnGo.textContent = "Faltan 2 pasos…";
      msg.textContent = "Primero Instagram y Facebook. Luego finalizás.";
    }
  }

  // PASO 1: abrir IG + autorizar (así ya tienen internet)
  function handleIg(){
    openNew(LINKS.ig);
    state.ig = true; persist();
    $("#ok1").classList.add("show");
    authorize().then(updateUI);
  }

  // PASO 2: abrir FB (ya con internet habilitado)
  function handleFb(){
    openNew(LINKS.fb);
    state.fb = true; persist();
    $("#ok2").classList.add("show");
    authorize().then(updateUI);
  }

  // PASO 3: feedback final (no redirigimos a otra página)
  function handleGo(){
    $("#okline").style.display = "block";
    // intentamos cerrar la vista cautiva si el SO lo permite
    try{ window.close(); }catch(_){}
  }

  // Soporte para distintos gestos (algunos CNAs priorizan touchstart)
  btnIg.addEventListener("touchstart", handleIg, {passive:true});
  btnIg.addEventListener("click",      handleIg, {passive:true});
  btnFb.addEventListener("touchstart", handleFb, {passive:true});
  btnFb.addEventListener("click",      handleFb, {passive:true});
  btnGo.addEventListener("click",      handleGo, {passive:true});
})();
</script>
</body>
</html>
